# Guide d'utilisation pour demo_api

## Fonctionnalit√©s

- ‚úì Gestion s√©curis√©e des mots de passe avec variables d'environnement et saisie interactive
- ‚úì Logging structur√© avec structlog pour debugging et monitoring
- ‚úì API unifi√©e pour les utilisateurs et VMs
- ‚úì Sauvegarde automatique en JSON des donn√©es r√©cup√©r√©es

## Installation des d√©pendances

```bash
pip install -r requirements.txt
```

## Configuration centralis√©e

Le projet utilise maintenant un syst√®me de configuration centralis√©e avec `python-dotenv` qui g√®re automatiquement tous les param√®tres de l'application.

### Variables d'environnement disponibles

Le syst√®me de configuration g√®re les variables d'environnement suivantes :

### Variables disponibles

#### **Configuration API :**
- `DEMO_API_BASE_URL` : URL de base de l'API (d√©faut: https://x8ki-letl-twmt.n7.xano.io/api:N1uLlTBt)
- `DEMO_API_TIMEOUT` : Timeout des requ√™tes en secondes (d√©faut: 5)
- `DEMO_API_MAX_RETRIES` : Nombre de tentatives en cas d'√©chec (d√©faut: 3)

#### **Authentification :**
- `DEMO_API_EMAIL` : Email pour se connecter √† l'API
- `DEMO_API_PASSWORD` : Mot de passe pour se connecter √† l'API
- `DEMO_API_TOKEN` : Token d'authentification (optionnel - cr√©√© automatiquement)

#### **Logging :**
- `DEMO_API_DEBUG` : Active le mode debug (true/false)
- `DEMO_API_LOG_LEVEL` : Niveau de logging (DEBUG, INFO, WARNING, ERROR)

#### **Fichiers :**
- `DEMO_API_OUTPUT_FILE` : Nom du fichier de sortie JSON (d√©faut: vm_users.json)

### Configuration

1. **Via les variables d'environnement** (recommand√© pour la production) :
   ```bash
   export DEMO_API_EMAIL="jean@dupont21.com"
   export DEMO_API_PASSWORD="motdepasse_securise"
   python main.py
   ```

2. **Via un fichier .env** (vous pouvez utiliser python-dotenv si n√©cessaire) :
   ```bash
   # Cr√©er un fichier .env
   echo "DEMO_API_EMAIL=jean@dupont21.com" >> .env
   echo "DEMO_API_PASSWORD=motdepasse_securise" >> .env
   ```

3. **Saisie interactive** (si aucune variable d'environnement) :
   Le script demandera automatiquement la saisie s√©curis√©e du mot de passe.

### S√©curit√©

- Les mots de passe ne sont jamais affich√©s en claire
- La saisie interactive utilise `getpass` qui masque la saisie
- Les variables d'environnement permettent d'√©viter les mots de passe en dur dans le code
- Ne jamais committer de fichiers .env dans le versioning

### Fonctionnement

Le code v√©rifie d'abord les variables d'environnement, puis demande une saisie interactive si celles-ci ne sont pas d√©finies.

## Logging avec structlog

Le syst√®me utilise `structlog` pour un logging structur√© et professionnel :

### Configuration automatique
- Logging avec couleurs dans le terminal
- Format JSON en production
- Monitoring des performances des API calls
- Gestion d'erreurs d√©taill√©e

### Exemples de logs g√©n√©r√©s
```
2024-01-15T10:30:45Z INFO D'but de l'ex¬Çcution de demo_api base_url=https://x8ki-letl-twmt.n7.xano.io/api:N1uLlTBt
2024-01-15T10:30:45Z INFO R'cup√´ration des utilisateurs depuis l'API base_url=https://x8ki-letl-twmt.n7.xano.io/api:N1uLlTBt
2024-01-15T10:30:46Z INFO Utilisateurs r'cup√´r√©s count=15 status_code=200
```

### Utilisation

```bash
# Mode d√©veloppement avec logs d√©taill√©s
DEMO_API_DEBUG=true python main.py

# Mode production avec logs minimaux
DEMO_API_LOG_LEVEL=WARNING python main.py

# Logs seulement les erreurs et avertissements
DEMO_API_LOG_LEVEL=WARNING python main.py
```

### Avantages du logging structur√©

- **Debugging facile** : Recherche rapide des erreurs par email, user_id, etc.
- **Monitoring** : Suivi des performances et des erreurs
- **Audit** : Tra√ßabilit√© compl√®te des actions utilisateurs
- **Production-ready** : Format adapt√© aux syst√®mes de monitoring

## Gestion intelligente des tokens d'authentification

Le syst√®me dispose de fonctions avanc√©es pour g√©rer les tokens d'authentification :

### Fonctions sp√©cialis√©es par type d'acc√®s

#### **Variables d'environnement :**
- `get_token_from_env()` : R√©cup√®re un token depuis les variables d'environnement
- `save_token_to_env()` : Sauvegarde un token dans les variables d'environnement
- `remove_token_from_env()` : Supprime un token des variables d'environnement

#### **Fichiers .env avec python-dotenv :**
- `save_token_to_env_file()` : Sauvegarde un token dans un fichier .env
- `load_token_from_env_file()` : Charge un token depuis un fichier .env
- `load_env_files()` : Charge automatiquement plusieurs fichiers .env

#### **Gestion intelligente :**
- `get_or_create_token()` : Fonction tout-en-un qui essaie de r√©cup√©rer un token existant ou en cr√©e un nouveau

### Utilisation recommand√©e

```python
from utils.password_utils import get_or_create_token

# Utilisation simple - g√®re automatiquement tout
token = get_or_create_token(
    base_url="https://api.example.com",
    email="user@example.com",
    token_env_var="DEMO_API_TOKEN"
)
```

### Avantages de cette approche

- **üöÄ Performance** : R√©utilise les tokens valides sans nouvelle authentification
- **üîí S√©curit√©** : Validation automatique des tokens avant utilisation
- **üíæ Persistance** : Sauvegarde entre les sessions pour √©viter les reconnexions
- **üîÑ Flexibilit√©** : Support des variables d'environnement ET des fichiers .env
- **üõ°Ô∏è Robustesse** : Gestion automatique des tokens expir√©s

### Sc√©narios d'usage

1. **Premi√®re ex√©cution** : Demande les identifiants, cr√©e et sauvegarde le token
2. **Ex√©cutions suivantes** : Utilise le token sauvegard√© (plus rapide)
3. **Token expir√©** : D√©tecte automatiquement et recr√©e un nouveau token
4. **Environnement de production** : Utilise uniquement les tokens des variables d'environnement

## Utilisation de la configuration centralis√©e

### Import et configuration

```python
from utils.config import config

# Acc√®s direct aux propri√©t√©s
base_url = config.DEMO_API_BASE_URL
timeout = config.DEMO_API_TIMEOUT
debug_mode = config.DEMO_API_DEBUG
```

### Propri√©t√©s pratiques

```python
# V√©rification de l'environnement
if config.is_production:
    print("Mode production activ√©")

# V√©rification des identifiants
if config.has_credentials:
    print("Identifiants disponibles")

# Headers d'authentification automatiques
headers = config.auth_headers
if headers:
    api_call(url, headers=headers)

# Configuration client compl√®te
client_config = config.client_config
# {'base_url': '...', 'timeout': 5, 'max_retries': 3, 'ssl_verify': True}
```

### Validation automatique

Les configurations sont automatiquement valid√©es au d√©marrage :
- URL valide (commence par `http`)
- Niveau de log valide
- Valeurs num√©riques positives
- Format des bool√©ens

## Organisation des fichiers .env avec python-dotenv

Le syst√®me utilise `python-dotenv` pour une gestion robuste des fichiers de configuration :

### Hi√©rarchie des fichiers .env

```
.env.defaults  ‚Üê Valeurs par d√©faut (peut √™tre versionn√©)
.env.local     ‚Üê Configuration locale (√† ignorer dans git)
.env          ‚Üê Configuration g√©n√©rale (peut √™tre versionn√©)
```

### Chargement automatique

Les fichiers sont charg√©s automatiquement dans cet ordre (chaque fichier surcharge le pr√©c√©dent) :

```python
# Chargement automatique au d√©marrage de password_utils
load_env_files()  # Charge .env.defaults ‚Üí .env.local ‚Üí .env
```

### Utilisation pratique

```bash
# Workflow de d√©veloppement typique :
# 1. Copier env.example vers .env
cp env.example .env

# 2. Modifier vos vraies valeurs dans .env
echo "DEMO_API_EMAIL=votre.email@domain.com" >> .env
echo "DEMO_API_TOKEN=votre_token" >> .env

# 3. Cr√©er .env.local pour des valeurs sensibles (ignor√© par git)
echo "DEMO_API_PASSWORD=mot_de_passe_confidential" >> .env.local

# 4. Lancer l'application (charge automatiquement tous les fichiers)
python main.py
```

### Avantages de python-dotenv

- **‚úÖ Chargement automatique** : Pas besoin de configuration manuelle
- **‚úÖ Hi√©rarchie de configuration** : Fichiers par priorit√©
- **‚úÖ Format standard** : Compatible avec tous les outils
- **‚úÖ S√©curit√©** : Support des variables sensibles locales
- **‚úÖ D√©veloppement** : Configuration flexible par environnement

## API unifi√©e avec interface fluide

Le projet dispose maintenant d'une API unifi√©e avec une interface fluide et intuitive pour toutes les op√©rations.

### Interface principale

```python
from utils.api import Api, create_authenticated_client

# Cr√©ation du client API
api = Api()  # Utilise la configuration par d√©faut
# ou
api = Api("https://custom.api.url")  # URL personnalis√©e
# ou
api = Api(token="existing_token")  # Avec token existant
```

### Interface fluide par domaine

#### **üë• Op√©rations sur les utilisateurs :**
```python
# R√©cup√©ration des utilisateurs
users = api.users.get()

# Association des VMs aux utilisateurs
api.users.add_vms_to_users(users, vms)

# Cr√©ation d'une VM pour un utilisateur
vm = api.users.create_vm(
    user_id=1,
    name="Ma VM",
    operating_system="Ubuntu 22.04",
    cpu_cores=2,
    ram_gb=4,
    disk_gb=50,
    status="stopped"
)
```

#### **üñ•Ô∏è Op√©rations sur les VMs :**
```python
# R√©cup√©ration des VMs
vms = api.vms.get()

# Cr√©ation d'une VM
vm = api.vms.create(
    user_id=1,
    name="Ma VM",
    operating_system="CentOS 8",
    cpu_cores=1,
    ram_gb=2,
    disk_gb=25,
    status="running"
)
```

#### **üîê Authentification :**
```python
# Connexion
token = api.login("email@example.com", "password")

# Cr√©ation d'utilisateur
token = api.create_user("Jean Dupont", "jean@example.com", "password")

# Informations utilisateur connect√©
user_info = api.get_user_info()
```

### M√©thodes utilitaires

```python
# V√©rification de l'authentification
if api.is_authenticated():
    print("Utilisateur connect√©")

# Gestion des tokens
api.set_token("new_token")
api.clear_token()

# Repr√©sentation du client
print(api)  # ApiClient(base_url='...', authenticated=True)
```

### Client avec authentification automatique

```python
# Cr√©ation automatique avec authentification
api = create_authenticated_client()

# Utilise automatiquement les identifiants de la configuration
# ou demande une saisie interactive si n√©cessaire
```

### Avantages de l'API unifi√©e

- **üéØ Interface intuitive** : `api.users.get()` au lieu de `get_users(base_url)`
- **üîó Interface fluide** : Encha√Ænement naturel des op√©rations
- **üì¶ Organisation logique** : S√©paration par domaine (users, vms, auth)
- **üîí Gestion automatique** : Authentification transparente
- **‚ö° M√©thodes raccourcies** : `api.login()` au lieu de `api.auth.login()`
- **üõ°Ô∏è Type hinting** : Documentation et validation automatique
- **üîß Configuration int√©gr√©e** : Utilise automatiquement la configuration centralis√©e
